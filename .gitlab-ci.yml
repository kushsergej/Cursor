stages:
  - backup
  - restore

backup_db:
  stage: backup
  image: mcr.microsoft.com/azure-cli
  script:
    - |
      set -e
      # Log function
      echo_log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"; }

      echo_log "Starting Azure authentication..."
      az login --service-principal -u "$AZURE_CLIENT_ID" -p "$AZURE_CLIENT_SECRET" --tenant "$AZURE_TENANT_ID"
      az account set --subscription "$AZURE_SUBSCRIPTION_ID"
      echo_log "Authenticated to Azure."

      echo_log "Checking for Recovery Services Vault: $AZURE_VAULT_NAME in resource group: $AZURE_RESOURCE_GROUP..."
      VAULT_EXISTS=$(az backup vault list --resource-group "$AZURE_RESOURCE_GROUP" --query "[?name=='$AZURE_VAULT_NAME'] | length(@)")
      if [ "$VAULT_EXISTS" -eq 0 ]; then
        echo_log "Vault does not exist. Creating..."
        az backup vault create --name "$AZURE_VAULT_NAME" --resource-group "$AZURE_RESOURCE_GROUP"
        echo_log "Vault created."
      else
        echo_log "Vault already exists."
      fi
      echo_log "Vault check complete."

      echo_log "Listing all Azure PostgreSQL Flexible Servers in the subscription..."
      PG_SERVERS=$(az postgres flexible-server list --query "[].name" -o tsv)
      for SERVER in $PG_SERVERS; do
        echo_log "Processing server: $SERVER"
        echo_log "Triggering backup for server: $SERVER"
        az postgres flexible-server backup create \
          --name "$SERVER" \
          --resource-group "$AZURE_RESOURCE_GROUP"
        echo_log "Backup triggered for $SERVER."
      done
      echo_log "All server backups triggered."
  variables:
    AZURE_CLIENT_ID: $AZURE_CLIENT_ID
    AZURE_TENANT_ID: $AZURE_TENANT_ID
    AZURE_CLIENT_SECRET: $AZURE_CLIENT_SECRET
    AZURE_SUBSCRIPTION_ID: $AZURE_SUBSCRIPTION_ID
    AZURE_RESOURCE_GROUP: $AZURE_RESOURCE_GROUP
    AZURE_VAULT_NAME: $AZURE_VAULT_NAME
  when: manual
  only:
    - schedules
    - manual

restore_db:
  stage: restore
  image: mcr.microsoft.com/azure-cli
  script:
    - |
      set -e
      echo_log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"; }
      echo_log "Starting Azure authentication..."
      az login --service-principal -u "$AZURE_CLIENT_ID" -p "$AZURE_CLIENT_SECRET" --tenant "$AZURE_TENANT_ID"
      az account set --subscription "$AZURE_SUBSCRIPTION_ID"
      echo_log "Authenticated to Azure."
      echo_log "Restoring Azure PostgreSQL Flexible Server..."
      # Required variables: RESTORE_SERVER_NAME, SOURCE_SERVER_NAME, RESTORE_TIME (ISO8601)
      az postgres flexible-server restore \
        --name "$RESTORE_SERVER_NAME" \
        --resource-group "$AZURE_RESOURCE_GROUP" \
        --source-server "$SOURCE_SERVER_NAME" \
        --restore-time "$RESTORE_TIME"
      echo_log "Restore triggered for $RESTORE_SERVER_NAME from $SOURCE_SERVER_NAME at $RESTORE_TIME."
  variables:
    AZURE_CLIENT_ID: $AZURE_CLIENT_ID
    AZURE_TENANT_ID: $AZURE_TENANT_ID
    AZURE_CLIENT_SECRET: $AZURE_CLIENT_SECRET
    AZURE_SUBSCRIPTION_ID: $AZURE_SUBSCRIPTION_ID
    AZURE_RESOURCE_GROUP: $AZURE_RESOURCE_GROUP
    AZURE_VAULT_NAME: $AZURE_VAULT_NAME
    RESTORE_SERVER_NAME: $RESTORE_SERVER_NAME
    SOURCE_SERVER_NAME: $SOURCE_SERVER_NAME
    RESTORE_TIME: $RESTORE_TIME
  when: manual
